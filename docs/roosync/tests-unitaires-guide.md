# Guide Tests Unitaires RooSync - Phase 3

## üéØ Objectif

Guide de r√©f√©rence pour l'utilisation, l'ajout et la maintenance des tests unitaires RooSync en mode **dry-run**.

---

## üì¶ Architecture Tests

### Structure Consolid√©e

```
tests/roosync/
‚îú‚îÄ‚îÄ README.md                            # Documentation principale
‚îú‚îÄ‚îÄ helpers/                             # Utilitaires communs (DRY)
‚îÇ   ‚îú‚îÄ‚îÄ test-logger.ts                  # Logger isol√© tests
‚îÇ   ‚îú‚îÄ‚îÄ test-git.ts                     # Mocks Git safe
‚îÇ   ‚îî‚îÄ‚îÄ test-deployment.ts              # Mocks PowerShell
‚îú‚îÄ‚îÄ fixtures/                            # Donn√©es test r√©utilisables
‚îÇ   ‚îú‚îÄ‚îÄ logger-config.json              # Configurations logger
‚îÇ   ‚îî‚îÄ‚îÄ deployment-scripts.json         # Scripts PowerShell test
‚îú‚îÄ‚îÄ run-all-tests.ts                    # Runner ex√©cution 4 batteries
‚îú‚îÄ‚îÄ test-logger-rotation-dryrun.ts      # Test 1: Logger rotation
‚îú‚îÄ‚îÄ test-git-helpers-dryrun.ts          # Test 2: Git helpers
‚îú‚îÄ‚îÄ test-deployment-wrappers-dryrun.ts  # Test 3: Deployment wrappers
‚îî‚îÄ‚îÄ test-task-scheduler-dryrun.ps1      # Test 4: Task scheduler
```

---

## üß™ Batteries de Tests

### Test 1 : Logger Rotation

**Fichier** : `test-logger-rotation-dryrun.ts`

**Objectifs** :
- Valider rotation logs par taille (10MB max)
- Valider rotation logs par date (7 jours)
- Valider suppression anciens logs (>7 jours)

**Contraintes** :
- Mode dry-run uniquement
- Logs isol√©s dans `tests/results/roosync/logger-test-logs/`
- Aucune modification logs production (`RooSync/logs/`)

**Ex√©cution** :
```bash
npx ts-node tests/roosync/test-logger-rotation-dryrun.ts
```

**Rapport** : `tests/results/roosync/logger-test-logs/test-report.json`

---

### Test 2 : Git Helpers

**Fichier** : `test-git-helpers-dryrun.ts`

**Objectifs** :
- Valider `verifyGitAvailable()` (Git pr√©sent/absent)
- Valider `safePull()` avec mock (succ√®s/√©chec + rollback)
- Valider `safeCheckout()` avec mock (succ√®s/√©chec + rollback)

**Contraintes** :
- Mocks uniquement (pas de modifications repo Git)
- V√©rification SHA avant/apr√®s op√©ration
- Rollback automatique en cas d'√©chec

**Ex√©cution** :
```bash
npx ts-node tests/roosync/test-git-helpers-dryrun.ts
```

**Rapport** : `tests/results/roosync/test2-git-helpers-report.json`

---

### Test 3 : Deployment Wrappers

**Fichier** : `test-deployment-wrappers-dryrun.ts`

**Objectifs** :
- Valider timeout scripts PowerShell (>30s)
- Valider gestion erreurs (exit code != 0)
- Valider mode dry-run (deployModes({ dryRun: true }))

**Contraintes** :
- Scripts PowerShell test isol√©s (`deployment-test-scripts/`)
- Timeout d√©tect√© correctement
- Erreurs g√©r√©es sans interruption

**Ex√©cution** :
```bash
npx ts-node tests/roosync/test-deployment-wrappers-dryrun.ts
```

**Rapport** : `tests/results/roosync/test3-deployment-report.json`

---

### Test 4 : Task Scheduler

**Fichier** : `test-task-scheduler-dryrun.ps1`

**Objectifs** :
- V√©rifier task scheduler Windows accessible
- Simuler cr√©ation t√¢che (dry-run)
- V√©rifier triggers cron (2h interval)

**Contraintes** :
- Mode dry-run uniquement (pas de t√¢che cr√©√©e)
- V√©rification permissions administrateur
- Validation format cron

**Ex√©cution** :
```bash
pwsh -File tests/roosync/test-task-scheduler-dryrun.ps1
```

**Rapport** : Console output (pas de JSON g√©n√©r√©)

---

## üöÄ Ex√©cution Tests

### Runner Automatique (Recommand√©)

Ex√©cute les 4 batteries s√©quentiellement :

```bash
npx ts-node tests/roosync/run-all-tests.ts
```

**Avantages** :
- Ex√©cution s√©quentielle (√©vite conflits)
- Rapport consolid√© unique
- Taux succ√®s global calcul√©
- Logs d√©taill√©s

**Rapport consolid√©** : `tests/results/roosync/all-tests-report.json`

---

### Ex√©cution Manuelle

Pour ex√©cuter tests individuellement :

```bash
# Test 1 - Logger Rotation
npx ts-node tests/roosync/test-logger-rotation-dryrun.ts

# Test 2 - Git Helpers
npx ts-node tests/roosync/test-git-helpers-dryrun.ts

# Test 3 - Deployment Wrappers
npx ts-node tests/roosync/test-deployment-wrappers-dryrun.ts

# Test 4 - Task Scheduler
pwsh -File tests/roosync/test-task-scheduler-dryrun.ps1
```

---

## üìä Rapports de Tests

### Format JSON Standard

Tous les tests TypeScript g√©n√®rent un rapport JSON standardis√© :

```json
{
  "timestamp": "2025-10-24T23:00:00.000Z",
  "testsRun": 3,
  "testsPassed": 3,
  "testsFailed": 0,
  "successRate": 100,
  "results": [
    {
      "testName": "Rotation par taille (10MB)",
      "success": true,
      "details": "‚úÖ Rotation d√©clench√©e apr√®s d√©passement seuil. Fichiers cr√©√©s: 2",
      "observations": [
        "Fichier initial: test-roosync-20251024.log",
        "Fichier apr√®s rotation: test-roosync-20251024-2.log",
        "Nombre fichiers logs: 2"
      ]
    }
  ]
}
```

### Rapport Consolid√©

Le runner `run-all-tests.ts` g√©n√®re un rapport consolid√© :

```json
{
  "timestamp": "2025-10-24T23:00:00.000Z",
  "batteriesRun": 4,
  "batteriesSuccess": 4,
  "batteriesFailed": 0,
  "overallSuccessRate": 100,
  "individualTests": {
    "total": 14,
    "passed": 14,
    "failed": 0
  },
  "results": [...]
}
```

---

## üõ†Ô∏è Ajout de Nouveaux Tests

### √âtape 1 : Utiliser les Helpers

Importer les utilitaires communs :

```typescript
import { TestLogger, TestResult, generateTestReport } from './helpers/test-logger';
import { mockVerifyGitAvailable, mockSafePull } from './helpers/test-git';
import { createTimeoutTestScript } from './helpers/test-deployment';

const logger = new TestLogger('./tests/results/roosync/my-test.log');
```

### √âtape 2 : Utiliser les Fixtures

Charger configurations r√©utilisables :

```typescript
import loggerConfig from './fixtures/logger-config.json';
import deploymentScripts from './fixtures/deployment-scripts.json';

const logger = new Logger(loggerConfig.testConfig);
const scriptsDir = deploymentScripts.testScriptsDir;
```

### √âtape 3 : Cr√©er Fichier Test

Suivre le pattern standard :

```typescript
/**
 * TEST X - Description
 * 
 * Objectif : ...
 * 
 * Tests :
 * - X.1 : ...
 * - X.2 : ...
 * 
 * CONTRAINTES :
 * - Mode DRY-RUN uniquement
 * - Logs isol√©s dans tests/results/roosync/
 */

import { TestLogger, TestResult, generateTestReport } from './helpers/test-logger';

const logger = new TestLogger('./tests/results/roosync/testX-output.log');
const REPORT_PATH = './tests/results/roosync/testX-report.json';

const results: TestResult[] = [];

// Test X.1 : ...
function testCase1(): TestResult {
  logger.section('Test X.1 : ...');
  
  try {
    // Impl√©mentation test...
    
    return {
      testName: 'Test X.1',
      success: true,
      details: '‚úÖ Test r√©ussi',
      observations: ['...']
    };
  } catch (error) {
    return {
      testName: 'Test X.1',
      success: false,
      details: `‚ùå Erreur : ${error.message}`
    };
  }
}

// Ex√©cuter tests
results.push(testCase1());

// G√©n√©rer rapport
generateTestReport(results, REPORT_PATH);

// Exit code
const allPassed = results.every((r) => r.success);
process.exit(allPassed ? 0 : 1);
```

### √âtape 4 : Ajouter au Runner

Modifier `run-all-tests.ts` pour inclure le nouveau test :

```typescript
const TESTS = [
  // ... tests existants
  {
    name: 'Test X - Description',
    command: 'npx ts-node tests/roosync/testX.ts',
    reportPath: 'tests/results/roosync/testX-report.json',
  },
];
```

---

## üìö Best Practices

### ‚úÖ DO

1. **Utiliser helpers/** : Pas de duplication code logger/mocks
2. **Isoler logs** : `tests/results/roosync/` uniquement
3. **Mode dry-run** : Aucune modification production
4. **Rapports JSON** : Tra√ßabilit√© compl√®te
5. **Nettoyage** : `cleanupTestEnv()` avant/apr√®s tests
6. **Commentaires JSDoc** : Documentation inline
7. **Assertions claires** : Messages d'erreur explicites

### ‚ùå DON'T

1. Modifier logs production (`RooSync/logs/`)
2. Modifier configuration production (`RooSync/config/`)
3. Commiter fichiers `tests/results/` (ajout√©s au `.gitignore`)
4. Cr√©er nouveau logger (utiliser `helpers/test-logger.ts`)
5. Ex√©cuter sans dry-run (risque corruption)
6. Supprimer fixtures (donn√©es r√©utilisables)
7. Tests interd√©pendants (isolation obligatoire)

---

## üîç Debugging

### Logs D√©taill√©s

Activer logs verbeux :

```bash
export DEBUG=true
npx ts-node tests/roosync/test-logger-rotation-dryrun.ts
```

### Rapports JSON

Consulter rapports individuels :

```bash
# Test 1 - Logger
cat tests/results/roosync/logger-test-logs/test-report.json | jq .

# Test 2 - Git
cat tests/results/roosync/test2-git-helpers-report.json | jq .

# Test 3 - Deployment
cat tests/results/roosync/test3-deployment-report.json | jq .

# Rapport consolid√©
cat tests/results/roosync/all-tests-report.json | jq .
```

### Logs Fichiers

Consulter logs d√©taill√©s :

```bash
# Test 1 - Logger
tail -f tests/results/roosync/logger-test-logs/test-roosync-20251024.log

# Test 2 - Git
tail -f tests/results/roosync/test2-git-helpers-output.log

# Test 3 - Deployment
tail -f tests/results/roosync/test3-deployment-output.log

# Runner
tail -f tests/results/roosync/run-all-tests.log
```

---

## üîß Maintenance

### Nettoyage Logs Test

Nettoyer logs test anciens :

```bash
# Supprimer logs >7 jours
find tests/results/roosync/ -name "*.log" -mtime +7 -delete

# Nettoyer tous logs test (r√©initialisation)
rm -rf tests/results/roosync/*.log
rm -rf tests/results/roosync/logger-test-logs/*.log
```

### Mise √† Jour Helpers

Modifier helpers communs :

1. √âditer `helpers/test-logger.ts`, `helpers/test-git.ts`, etc.
2. V√©rifier compatibilit√© avec tests existants
3. Ex√©cuter `run-all-tests.ts` pour validation
4. Commiter si 14/14 tests PASS

### Ajout Fixtures

Ajouter configurations r√©utilisables :

1. Cr√©er `fixtures/nouvelle-config.json`
2. Importer dans tests : `import config from './fixtures/nouvelle-config.json'`
3. Documenter dans `README.md`

---

## üì¶ D√©pendances

- **Node.js** >= 18.x
- **TypeScript** >= 5.x
- **PowerShell** >= 7.x (pour Test 4)
- **Git** >= 2.x (pour Test 2)

Installation :

```bash
npm install --save-dev typescript ts-node @types/node
```

---

## üéØ Objectifs de Qualit√©

### Cibles

- **Couverture tests** : 100% composants critiques
- **Taux succ√®s** : 14/14 tests PASS (100%)
- **Temps ex√©cution** : <2 minutes (4 batteries)
- **Isolation** : 0 modification production

### M√©triques

Consulter rapport consolid√© :

```bash
npx ts-node tests/roosync/run-all-tests.ts
# Affiche :
# - Batteries : 4/4 PASS (100%)
# - Tests individuels : 14/14 PASS (100%)
# - Dur√©e totale : ~120s
```

---

## üìû Support

**Questions** : Consulter `tests/roosync/README.md`

**Issues** : V√©rifier logs `tests/results/roosync/*.log`

**Rapports** : Consulter `tests/results/roosync/*-report.json`

---

## üìÖ Historique

- **2025-10-24** : Phase 3 - Cr√©ation tests unitaires dry-run
- **2025-10-24** : Consolidation structure (helpers/, fixtures/, runner)
- **2025-10-24** : Documentation guide tests unitaires

---

## üöÄ Prochaines √âtapes

1. **CI/CD** : Int√©grer tests dans pipeline GitHub Actions
2. **Coverage** : Ajouter analyse couverture code (Jest/NYC)
3. **Performance** : Ajouter tests charge/stress
4. **Int√©gration** : Tests multi-composants (logger + Git + deployment)
5. **E2E** : Tests bout-en-bout RooSync complet

---

## üìñ R√©f√©rences

- [README Tests](../../tests/roosync/README.md)
- [Helper Logger](../../tests/roosync/helpers/test-logger.ts)
- [Helper Git](../../tests/roosync/helpers/test-git.ts)
- [Helper Deployment](../../tests/roosync/helpers/test-deployment.ts)
- [Fixtures Logger](../../tests/roosync/fixtures/logger-config.json)
- [Fixtures Deployment](../../tests/roosync/fixtures/deployment-scripts.json)