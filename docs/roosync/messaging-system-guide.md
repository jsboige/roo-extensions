# üì® RooSync Messaging System - Guide Complet

**Version** : 2.0 + Amendment Feature  
**Date** : 20 octobre 2025  
**Status** : ‚úÖ Production Ready

---

## üéØ Vue d'Ensemble

Syst√®me de messagerie asynchrone pour communication inter-machines RooSync v2.0 MCP. Permet l'√©change de messages structur√©s entre agents Claude via un r√©pertoire partag√© (Google Drive).

**7 outils MCP disponibles** :

1. [`roosync_send_message`](#roosync_send_message) - Envoyer message
2. [`roosync_read_inbox`](#roosync_read_inbox) - Lire bo√Æte de r√©ception
3. [`roosync_get_message`](#roosync_get_message) - Obtenir d√©tails message
4. [`roosync_mark_read`](#roosync_mark_read) - Marquer comme lu
5. [`roosync_archive_message`](#roosync_archive_message) - Archiver message
6. [`roosync_reply_message`](#roosync_reply_message) - R√©pondre √† message
7. [`roosync_amend_message`](#roosync_amend_message) - Modifier message envoy√© ‚ú® **NOUVEAU**

---

## üìä Architecture Fichiers

### R√©pertoires de Stockage

```
.shared-state/messages/
‚îú‚îÄ‚îÄ inbox/          # Messages re√ßus (tous agents)
‚îÇ   ‚îî‚îÄ‚îÄ msg-{timestamp}-{random}.json
‚îú‚îÄ‚îÄ sent/           # Messages envoy√©s (tous agents)
‚îÇ   ‚îî‚îÄ‚îÄ msg-{timestamp}-{random}.json
‚îî‚îÄ‚îÄ archive/        # Messages archiv√©s
    ‚îî‚îÄ‚îÄ msg-{timestamp}-{random}.json
```

### Format Message JSON

```json
{
  "id": "msg-20251019T225546-u85bim",
  "from": "myia-po-2024",
  "to": "myia-ai-01",
  "subject": "Diagnostic RooSync",
  "body": "Le probl√®me est dans InventoryCollector.ts ligne 151",
  "priority": "HIGH",
  "status": "unread",
  "tags": ["diagnostic", "bug-fix"],
  "thread_id": "roosync-debug-session-20251019",
  "reply_to": null,
  "timestamp": "2025-10-19T22:55:46.000Z",
  "read_at": null,
  "metadata": {
    "amended": false,
    "original_content": null,
    "amendment_reason": null,
    "amendment_timestamp": null
  }
}
```

**Champs cl√©s** :
- `id` : Identifiant unique (`msg-{ISO8601}-{random}`)
- `status` : `'unread' | 'read' | 'archived'`
- `priority` : `'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'`
- `metadata` : Informations amendements (si applicable)

---

## üõ†Ô∏è Outils MCP

### roosync_send_message

**Description** : Envoyer un message structur√© √† une machine destinataire.

**Param√®tres** :

```typescript
{
  to: string;          // Machine ID destinataire (ex: 'myia-ai-01')
  subject: string;     // Sujet du message
  body: string;        // Contenu du message (markdown accept√©)
  priority?: string;   // 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT' (d√©faut: 'MEDIUM')
  tags?: string[];     // Tags optionnels pour cat√©gorisation
  thread_id?: string;  // ID de thread pour conversations group√©es
}
```

**Retour** :

```typescript
{
  id: string;          // ID du message cr√©√©
  timestamp: string;   // ISO 8601 timestamp
  from: string;        // Machine ID √©mettrice
  to: string;          // Machine ID destinataire
  status: 'unread';    // Statut initial toujours 'unread'
}
```

**Exemple** :

```typescript
const message = await roosync_send_message({
  to: 'myia-ai-01',
  subject: 'Correction InventoryCollector',
  body: 'Bug corrig√© dans InventoryCollector.ts ligne 151. Tests valid√©s.',
  priority: 'HIGH',
  tags: ['bug-fix', 'validation'],
  thread_id: 'inventory-debug-20251019'
});

// message.id: "msg-20251019T225546-u85bim"
```

---

### roosync_read_inbox

**Description** : Lire tous les messages de la bo√Æte de r√©ception avec filtrage optionnel.

**Param√®tres** :

```typescript
{
  status?: string;     // Filtrer par statut ('unread' | 'read' | 'all')
  limit?: number;      // Nombre max de messages (d√©faut: 50)
}
```

**Retour** :

```typescript
{
  messages: Array<{
    id: string;
    from: string;
    subject: string;
    priority: string;
    status: string;
    timestamp: string;
    preview: string;   // Aper√ßu des 100 premiers caract√®res
  }>;
  total: number;       // Nombre total de messages
  unread: number;      // Nombre de messages non lus
}
```

**Exemple** :

```typescript
// Lire uniquement messages non lus
const inbox = await roosync_read_inbox({
  status: 'unread',
  limit: 10
});

console.log(`${inbox.unread} messages non lus`);
// Affiche liste avec aper√ßus
```

---

### roosync_get_message

**Description** : Obtenir le contenu complet d'un message sp√©cifique.

**Param√®tres** :

```typescript
{
  message_id: string;     // ID du message √† lire
  mark_as_read?: boolean; // Marquer automatiquement comme lu (d√©faut: false)
}
```

**Retour** :

```typescript
{
  message: {
    id: string;
    from: string;
    to: string;
    subject: string;
    body: string;        // Contenu complet (markdown)
    priority: string;
    status: string;
    tags: string[];
    thread_id?: string;
    reply_to?: string;
    timestamp: string;
    read_at?: string;
    metadata?: object;   // M√©tadonn√©es amendements si applicable
  };
}
```

**Exemple** :

```typescript
// Lire message et marquer comme lu
const result = await roosync_get_message({
  message_id: 'msg-20251019T225546-u85bim',
  mark_as_read: true
});

console.log(result.message.body); // Contenu complet
```

---

### roosync_mark_read

**Description** : Marquer un message comme lu. Met √† jour le statut dans **`inbox/` ET `sent/`** pour synchronisation compl√®te.

**Param√®tres** :

```typescript
{
  message_id: string;  // ID du message √† marquer
}
```

**Retour** :

```typescript
{
  success: boolean;
  message_id: string;
  marked_at: string;   // ISO 8601 timestamp
}
```

**Exemple** :

```typescript
await roosync_mark_read({
  message_id: 'msg-20251019T225546-u85bim'
});

// Status: 'unread' ‚Üí 'read'
// Fichier mis √† jour dans inbox/ ET sent/
```

---

### roosync_archive_message

**Description** : Archiver un message. D√©place le fichier de `inbox/` vers `archive/` et met √† jour `sent/`.

**Param√®tres** :

```typescript
{
  message_id: string;  // ID du message √† archiver
}
```

**Retour** :

```typescript
{
  success: boolean;
  message_id: string;
  archived_at: string; // ISO 8601 timestamp
}
```

**Exemple** :

```typescript
await roosync_archive_message({
  message_id: 'msg-20251019T225546-u85bim'
});

// Status: 'read' ‚Üí 'archived'
// Fichier d√©plac√© : inbox/ ‚Üí archive/
// Fichier mis √† jour dans sent/
```

---

### roosync_reply_message

**Description** : R√©pondre √† un message existant. Cr√©e un nouveau message li√© avec h√©ritage de contexte.

**Param√®tres** :

```typescript
{
  message_id: string;  // ID du message original
  body: string;        // Contenu de la r√©ponse
  priority?: string;   // Priorit√© (h√©rite du message original si omis)
}
```

**Retour** :

```typescript
{
  id: string;          // ID du nouveau message
  reply_to: string;    // ID du message original
  thread_id: string;   // ID de thread (h√©rit√©)
  timestamp: string;
}
```

**Fonctionnalit√©s automatiques** :
- ‚úÖ Inversion `from` ‚Üî `to`
- ‚úÖ H√©ritage `thread_id`
- ‚úÖ H√©ritage `priority` (si non sp√©cifi√©e)
- ‚úÖ Ajout tag `"reply"`
- ‚úÖ Pr√©fixe `"Re:"` au sujet

**Exemple** :

```typescript
const reply = await roosync_reply_message({
  message_id: 'msg-20251019T225546-u85bim',
  body: 'Correction valid√©e. Pull effectu√© avec succ√®s.'
});

// Nouveau message cr√©√© avec :
// - subject: "Re: Correction InventoryCollector"
// - reply_to: "msg-20251019T225546-u85bim"
// - thread_id: "inventory-debug-20251019" (h√©rit√©)
```

---

### roosync_amend_message

‚ú® **NOUVELLE FONCTIONNALIT√â**

**Description** : Modifier le contenu d'un message **envoy√©** avant qu'il ne soit lu par le destinataire.

**Cas d'usage** :
- Corriger faute de frappe ou information incorrecte
- Ajouter d√©tails oubli√©s
- Reformuler pour am√©liorer clart√©
- Retirer informations sensibles expos√©es par erreur

**Param√®tres** :

```typescript
{
  message_id: string;      // ID du message √† modifier (requis)
  new_content: string;     // Nouveau contenu (remplace original)
  reason?: string;         // Raison de l'amendement (optionnel)
}
```

**Retour** :

```typescript
{
  success: true;
  message_id: string;
  amended_at: string;      // ISO 8601 timestamp
  reason: string;
  original_content_preserved: boolean;  // Toujours true
}
```

**Contraintes** :

‚ùå **Interdit si** :
- Message d√©j√† lu (`status !== 'unread'`)
- Message archiv√© (`status === 'archived'`)
- √âmetteur n'est pas la machine courante (`from !== machine_id`)

‚úÖ **Autoris√©** :
- Message non lu, non archiv√©, √©mis par machine courante
- Plusieurs amendements successifs (original toujours pr√©serv√©)

**Exemple** :

```typescript
// 1. Envoyer message initial
const msg = await roosync_send_message({
  to: 'myia-po-2024',
  subject: 'Diagnostic RooSync',
  body: 'Le probl√®me est dans InventoryCollectur.ts ligne 151'  // Typo!
});

// 2. Corriger le message (avant lecture)
await roosync_amend_message({
  message_id: msg.id,
  new_content: 'Le probl√®me est dans InventoryCollector.ts ligne 151',
  reason: 'Fix typo in filename'
});

// 3. Le destinataire verra le contenu corrig√©
```

**M√©tadonn√©es ajout√©es** :

Lorsqu'un message est amend√©, les m√©tadonn√©es suivantes sont ajout√©es :

```json
{
  "metadata": {
    "amended": true,
    "original_content": "Le probl√®me est dans InventoryCollectur.ts ligne 151",
    "amendment_reason": "Fix typo in filename",
    "amendment_timestamp": "2025-10-19T22:00:00.000Z"
  }
}
```

**Note** : Le contenu original est **toujours pr√©serv√©**, m√™me en cas d'amendements multiples.

---

## üîÑ Workflow Complet

### Sc√©nario : Correction Message avec Erreur

```typescript
// 1. Envoi initial
const msg = await roosync_send_message({
  to: 'myia-ai-01',
  subject: 'Urgent: Config Error',
  body: 'Check file confg.json ligne 42',  // Typo!
  priority: 'URGENT'
});

// 2. D√©tection erreur
// Agent remarque la faute de frappe

// 3. Amendement (avant lecture)
await roosync_amend_message({
  message_id: msg.id,
  new_content: 'Check file config.json ligne 42',
  reason: 'Fix filename typo'
});

// 4. Agent distant lit message
// Voit contenu corrig√© directement

// 5. Historique pr√©serv√©
// M√©tadonn√©es conservent version originale pour audit
```

---

## üÜö Amendement vs Suppression + Renvoi

### Approche Ancienne (Probl√©matique)

```typescript
// ‚ùå Supprimer message original
await roosync_archive_message({ message_id: old_msg_id });

// ‚ùå Envoyer nouveau message
await roosync_send_message({
  to: 'agent-distant',
  subject: 'Diagnostic RooSync',
  body: 'Contenu corrig√©'
});
```

**Probl√®mes** :
- ‚ùå Perte tra√ßabilit√© (message original supprim√©)
- ‚ùå Nouveau message ID (r√©f√©rence cass√©e si d√©j√† partag√©e)
- ‚ùå Pollution bo√Æte de r√©ception (2 messages au lieu d'1)
- ‚ùå Risque confusion destinataire (2 sujets similaires)

### Approche Recommand√©e (Amendement)

```typescript
// ‚úÖ Amender message existant
await roosync_amend_message({
  message_id: existing_msg_id,
  new_content: 'Contenu corrig√©',
  reason: 'Fix critical error'
});
```

**Avantages** :
- ‚úÖ M√™me message ID (r√©f√©rences pr√©serv√©es)
- ‚úÖ Tra√ßabilit√© compl√®te (original + raison)
- ‚úÖ Bo√Æte de r√©ception propre (1 seul message)
- ‚úÖ Clart√© pour destinataire (voit version finale)

---

## üîí S√©curit√© et Contraintes

### Permissions

| Op√©ration | √âmetteur | Destinataire | Tiers |
|-----------|----------|--------------|-------|
| `send_message` | ‚úÖ | ‚ùå | ‚ùå |
| `amend_message` | ‚úÖ | ‚ùå | ‚ùå |
| `reply_message` | ‚úÖ | ‚úÖ | ‚ùå |
| `mark_read` | ‚úÖ | ‚úÖ | ‚ùå |
| `archive_message` | ‚úÖ | ‚úÖ | ‚ùå |

**R√®gles** :
- ‚úÖ **√âmetteur** : Peut amender ses propres messages uniquement
- ‚ùå **Destinataire** : Ne peut PAS amender messages re√ßus (doit r√©pondre via `reply`)
- ‚ùå **Tiers** : Aucune machine tierce ne peut amender

### √âtats Bloquants

| √âtat | Amendement Autoris√© | Raison |
|------|---------------------|--------|
| `unread` + `sent/` | ‚úÖ OUI | Message modifiable |
| `read` | ‚ùå NON | Destinataire a d√©j√† lu |
| `archived` | ‚ùå NON | Message archiv√© (historique fig√©) |
| √âmetteur diff√©rent | ‚ùå NON | Permissions insuffisantes |

### Tra√ßabilit√©

**Garanties** :
- ‚úÖ Contenu original **TOUJOURS** pr√©serv√© dans `metadata.original_content`
- ‚úÖ Raison amendement document√©e (obligatoire si non fournie : "Aucune raison fournie")
- ‚úÖ Timestamp amendement enregistr√©
- ‚úÖ Flag `amended: true` permanent (jamais supprim√©)

---

## üí° Bonnes Pratiques

### Avant Envoi

1. ‚úÖ **Relire message** : V√©rifier orthographe et informations
2. ‚úÖ **V√©rifier destinataire** : Confirmer machine ID correcte
3. ‚úÖ **Choisir priorit√©** : Adapter urgence au contexte
4. ‚úÖ **Ajouter tags** : Faciliter recherche ult√©rieure

### Amendement

1. ‚úÖ **Amender rapidement** : Corriger imm√©diatement si erreur d√©tect√©e
2. ‚úÖ **Raison explicite** : Toujours fournir `reason` pour tra√ßabilit√©
3. ‚úÖ **√âviter amendements r√©p√©t√©s** : V√©rifier corrections avant amender
4. ‚ùå **Ne pas amender apr√®s lecture** : Utiliser `reply` pour compl√©ter

### Archivage

1. ‚úÖ **Archiver apr√®s traitement** : Garder bo√Æte de r√©ception propre
2. ‚úÖ **Archiver conversations compl√®tes** : Conserver threads ensemble
3. ‚ùå **Ne pas archiver trop t√¥t** : Attendre fin de conversation

---

## üß™ Tests E2E

Suite compl√®te disponible : [`src/tools/roosync/__tests__/amend_message.test.ts`](../../mcps/internal/servers/roo-state-manager/src/tools/roosync/__tests__/amend_message.test.ts)

**7 tests couverts** (100% pass√©s) :

1. ‚úÖ Amendement message non lu (cas nominal)
2. ‚úÖ Refus amendement message lu
3. ‚úÖ Refus amendement message archiv√©
4. ‚úÖ Refus amendement message autre machine
5. ‚úÖ Refus amendement message inexistant
6. ‚úÖ Pr√©servation original lors amendements multiples
7. ‚úÖ Raison par d√©faut si non fournie

**Commande test** :

```bash
cd mcps/internal/servers/roo-state-manager
npm test -- --run src/tools/roosync/__tests__/amend_message.test.ts
```

---

## üìà Statistiques Syst√®me

| M√©trique | Valeur |
|----------|--------|
| **Outils MCP** | 7 |
| **Lignes de code** | ~2800 (service + outils + tests) |
| **Tests unitaires** | 49+ (MessageManager + outils) |
| **Coverage** | 70-100% |
| **Tests E2E** | 8/8 (100%) |
| **Documentation** | 1200+ lignes |

---

## üîó R√©f√©rences

**Fichiers source** :
- Service : [`MessageManager.ts`](../../mcps/internal/servers/roo-state-manager/src/services/MessageManager.ts)
- Outil amendement : [`amend_message.ts`](../../mcps/internal/servers/roo-state-manager/src/tools/roosync/amend_message.ts)
- Tests : [`amend_message.test.ts`](../../mcps/internal/servers/roo-state-manager/src/tools/roosync/__tests__/amend_message.test.ts)

**Documentation compl√©mentaire** :
- Architecture temporelle : [`roosync-temporal-messages-architecture.md`](../architecture/roosync-temporal-messages-architecture.md)
- Rapports impl√©mentation :
  - Phase 1 : [`roosync-messaging-phase1-implementation-20251016.md`](../../roo-config/reports/roosync-messaging-phase1-implementation-20251016.md)
  - Tests E2E : [`roosync-messaging-e2e-test-report-20251016.md`](../../roo-config/reports/roosync-messaging-e2e-test-report-20251016.md)

---

## üéØ Conclusion

`roosync_amend_message` compl√®te le syst√®me de messagerie RooSync avec capacit√© de correction pr√©-lecture, essentielle pour communication inter-agents fiable.

**Int√©gration** : Disponible d√®s compilation `roo-state-manager`, aucune configuration suppl√©mentaire requise.

**Prochaines √©volutions** :
- üîÑ Synchronisation temps-r√©el (webhooks)
- üìä Dashboard analytics messages
- üîç Recherche full-text dans historique
- üìé Support pi√®ces jointes (r√©f√©rences fichiers)

---

**Derni√®re mise √† jour** : 20 octobre 2025  
**Auteur** : myia-ai-01 (Code Mode)  
**Version doc** : 1.0