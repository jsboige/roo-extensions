# T3.7 - Analyse : Distinction Erreurs Script vs Syst√®me

**Date:** 2026-01-15
**Auteur:** Claude Code (myia-ai-01)
**Statut:** Analyse en cours

---

## üìã Objectif

Analyser et documenter la distinction entre **erreurs script** et **erreurs syst√®me** dans le codebase RooSync pour am√©liorer la classification et le traitement des erreurs.

---

## üîç √âtat Actuel

### Syst√®me d'Erreurs Existant

Le fichier [`src/types/errors.ts`](../../mcps/internal/servers/roo-state-manager/src/types/errors.ts) d√©finit une hi√©rarchie d'erreurs structur√©es :

```
StateManagerError (base)
‚îú‚îÄ‚îÄ ConfigServiceError
‚îú‚îÄ‚îÄ IdentityManagerError
‚îú‚îÄ‚îÄ BaselineLoaderError
‚îú‚îÄ‚îÄ BaselineServiceError
‚îú‚îÄ‚îÄ SynthesisServiceError
‚îú‚îÄ‚îÄ TraceSummaryServiceError
‚îú‚îÄ‚îÄ PowerShellExecutorError         ‚Üê Pertinent pour script/syst√®me
‚îú‚îÄ‚îÄ MessageManagerError
‚îú‚îÄ‚îÄ CacheManagerError
‚îú‚îÄ‚îÄ InventoryCollectorError        ‚Üê Pertinent pour script/syst√®me
‚îú‚îÄ‚îÄ RooStorageDetectorError
‚îú‚îÄ‚îÄ ExportConfigManagerError
‚îú‚îÄ‚îÄ ConfigSharingServiceError
‚îî‚îÄ‚îÄ GenericError
```

### Classification Actuelle

Les erreurs sont class√©es **par service**, pas par type d'erreur.

---

## üìä Analyse : Erreurs Script vs Syst√®me

### D√©finitions

| Type | D√©finition | Exemples |
|------|------------|----------|
| **Erreur Script** | Probl√®me dans le code PowerShell lui-m√™me | Syntaxe invalide, logique incorrecte, variables non d√©finies |
| **Erreur Syst√®me** | Probl√®me d'ex√©cution ind√©pendant du code | Fichier non trouv√©, timeout, permissions, r√©seau |

### Analyse par Service

#### PowerShellExecutorError

| Code | Type | Justification |
|------|------|---------------|
| `NO_JSON_FOUND` | **Syst√®me** | Le script n'a pas produit de JSON (logs parasites, format incorrect) |
| `EXECUTION_FAILED` | **Syst√®me** | Le processus PowerShell a √©chou√© (spawn, crash) |
| `TIMEOUT` | **Syst√®me** | Le script a trop mis de temps √† s'ex√©cuter |
| `SCRIPT_NOT_FOUND` | **Syst√®me** | Le fichier n'existe pas sur le disque |
| `PARSE_FAILED` | **Mixte** | Peut √™tre script (mauvais format) ou syst√®me (BOM, encodage) |

#### InventoryCollectorError

| Code | Type | Justification |
|------|------|---------------|
| `SCRIPT_NOT_FOUND` | **Syst√®me** | Fichier manquant |
| `SCRIPT_EXECUTION_FAILED` | **Mixte** | Peut √™tre script (bug) ou syst√®me (permissions) |
| `INVENTORY_PARSE_FAILED` | **Script** | Le JSON retourn√© ne correspond pas au schema attendu |
| `INVENTORY_SAVE_FAILED` | **Syst√®me** | Erreur d'√©criture disque |
| `REMOTE_MACHINE_NOT_FOUND` | **Syst√®me** | Machine inaccessible |
| `SHARED_STATE_NOT_ACCESSIBLE` | **Syst√®me** | Chemin r√©seau mont√© inaccessible |

#### GenericError

| Code | Type | Justification |
|------|------|---------------|
| `FILE_SYSTEM_ERROR` | **Syst√®me** | Disque, permissions |
| `NETWORK_ERROR` | **Syst√®me** | R√©seau inaccessible |
| `PERMISSION_DENIED` | **Syst√®me** | Droits insuffisants |
| `TIMEOUT` | **Syst√®me** | D√©lai d√©pass√© |
| `INVALID_ARGUMENT` | **Script** | Argument invalide = bug d'appel |

---

## üí° Recommandations

### 1. Ajouter un Champ `category` aux Erreurs

```typescript
export enum ErrorCategory {
  SCRIPT = 'SCRIPT',           // Bug dans le code PowerShell
  SYSTEM = 'SYSTEM',           // Probl√®me syst√®me (fichier, r√©seau, permissions)
  UNKNOWN = 'UNKNOWN'          // Impossible √† d√©terminer
}

export class StateManagerError extends Error {
  public readonly category: ErrorCategory;  // NOUVEAU

  constructor(
    message: string,
    code: string,
    service: string,
    category: ErrorCategory = ErrorCategory.UNKNOWN,  // NOUVEAU
    details?: any,
    cause?: Error
  ) {
    // ...
    this.category = category;
  }
}
```

### 2. Cr√©er une Fonction de D√©tection Automatique

```typescript
/**
 * D√©tecte si une erreur PowerShell est de type script ou syst√®me
 */
export function detectPowerShellErrorType(
  error: PowerShellExecutionResult
): ErrorCategory {
  // Indicateurs d'erreur script
  const scriptIndicators = [
    /syntax error/i,
    /unexpected token/i,
    /variable .* cannot be retrieved/i,
    /invalid operation/i
  ];

  // Indicateurs d'erreur syst√®me
  const systemIndicators = [
    /cannot find path/i,
    /access denied/i,
    /timeout/i,
    /network path not found/i
  ];

  const stderr = error.stderr.toLowerCase();

  if (scriptIndicators.some(pattern => pattern.test(stderr))) {
    return ErrorCategory.SCRIPT;
  }

  if (systemIndicators.some(pattern => pattern.test(stderr))) {
    return ErrorCategory.SYSTEM;
  }

  return ErrorCategory.UNKNOWN;
}
```

### 3. Mettre √† jour les Codes d'Erreur Existants

**PowerShellExecutorErrorCode:**
- Ajouter `SCRIPT_SYNTAX_ERROR` (script)
- Ajouter `SCRIPT_LOGIC_ERROR` (script)
- `PARSE_FAILED` ‚Üí diviser en `SCRIPT_INVALID_FORMAT` vs `SYSTEM_ENCODING_ERROR`

---

## üéØ Prochaines √âtapes

1. ‚úÖ **Analyse** - Ce document
2. ‚è≥ **Impl√©mentation** - Ajouter `category` aux erreurs
3. ‚è≥ **D√©tection** - Fonction de classification automatique
4. ‚è≥ **Tests** - Valider la classification
5. ‚è≥ **Documentation** - Mettre √† jour les docs utilisateurs

---

## üìö R√©f√©rences

- [`src/types/errors.ts`](../../mcps/internal/servers/roo-state-manager/src/types/errors.ts) - D√©finition des erreurs
- [`src/services/PowerShellExecutor.ts`](../../mcps/internal/servers/roo-state-manager/src/services/PowerShellExecutor.ts) - Ex√©cution PowerShell
- Issue #3.7 - Diff√©rencier erreurs script vs syst√®me

---

**Statut:** Analyse termin√©e, pr√™t pour impl√©mentation
